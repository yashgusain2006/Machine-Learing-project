import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns


dataset= pd.read_excel(r'C:\Users\gusai\OneDrive\Documents\loan_data (1).xlsx')

x=dataset.drop(columns=['loan_status'])
y=dataset['loan_status']

from sklearn.model_selection import train_test_split
x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2, random_state=42)
# outlier detection
num_columns = ["person_age","person_income","person_emp_exp","loan_amnt","loan_int_rate","loan_percent_income","cb_person_cred_hist_length","credit_score"]
"""for col in num_columns:
    sns.distplot(x_train[col])
    plt.title("Distribution of " + col)
    plt.show()"""

"""for col in num_columns:
    plt.boxplot(x_train[col])
    plt.title("Boxplot " + col)
    plt.show()"""

# outlier treatment

x_train = x_train[(x_train["person_age"] >= 18)&(x_train["person_age"] < 100)]

y_train = y_train.loc[x_train.index]

x_train['person_income'] = np.log1p(x_train['person_income'])
x_test['person_income'] = np.log1p(x_test['person_income'])

x_train=x_train[
    x_train["person_emp_exp"]<=x_train["person_age"]
]

cat_column = ["person_gender","person_education","person_home_ownership","loan_intent","previous_loan_defaults_on_file"]
from sklearn.compose import ColumnTransformer
from sklearn.preprocessing import OneHotEncoder, StandardScaler
#Encoding+Scaling
preprocessing = ColumnTransformer(transformers=[("encoding",OneHotEncoder(handle_unknown='ignore',drop='first'),cat_column),
("scaling",StandardScaler(),num_columns)],remainder='drop')
x_train = preprocessing.fit_transform(x_train)
x_test = preprocessing.transform(x_test)

#Feature Selection
from mlxtend.feature_selection import SequentialFeatureSelector
from sklearn.linear_model import LogisticRegression
lr=LogisticRegression()
sfs=SequentialFeatureSelector(lr,k_features='best',forward=True,floating=False,scoring='accuracy',cv=5)
x_train=sfs.fit_transform(x_train,y_train)
x_test=sfs.transform(x_test)
lrg=LogisticRegression()
lrg.fit(x_train,y_train)
user_data = {
    "person_age": int(input("Enter age: ")),
    "person_income": float(input("Enter income: ")),
    "person_emp_exp": int(input("Enter employment experience: ")),
    "loan_amnt": float(input("Enter loan amount: ")),
    "loan_int_rate": float(input("Enter interest rate: ")),
    "loan_percent_income": float(input("Enter loan % of income: ")),
    "cb_person_cred_hist_length": int(input("Enter credit history length: ")),
    "credit_score": int(input("Enter credit score: ")),
    "person_gender": input("Gender (male/female): "),
    "person_education": input("Education: "),
    "person_home_ownership": input("Home ownership (RENT/OWN/MORTGAGE): "),
    "loan_intent": input("Loan intent: "),
    "previous_loan_defaults_on_file": input("Previous default (Y/N): ")
}
user_df = pd.DataFrame([user_data])
user_df['person_income'] = np.log1p(user_df['person_income'])
user_pred=preprocessing.transform(user_df)
user_sfs=sfs.transform(user_pred)
prediction=lrg.predict(user_sfs)
probability=lrg.predict_proba(user_sfs)

print("\n==================== RESULT ====================")

if prediction[0] == 1:
    print("âœ… Loan Approved")
else:
    print("âŒ Loan Rejected")

print("Approval Probability:", round(probability[0][1]*100, 2), "%")
